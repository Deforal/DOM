<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="list_wrapper">
        
      </ul>
      <div class="loader display_none">
        Загрузка...
      </div>
      <div class="add-form">
        <p>Автор:</p>
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="name_for_comment"
        />
        <p class="display_none quote_placeholder">Цитата:</p>
        <div class="display_none quote_placeholder">
          <textarea 
            class="quote_placeholder_textarea" 
            style="overflow: hidden;" 
            disabled="yes">
          </textarea>
          <button class="quote_placeholder_clear">Очистить</button>
        </div>
        <p>Комментарий:</p>
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="comment_area"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="button_submit">Написать</button>
        </div>
        
      </div>
    </div>
    <script type="module" src="./api.js"></script>
    <script type="module" src="./render.js"></script>
  </body>

  <script>
    import { renderGET } from "./render.js";
    import { renderStudents } from "./render.js";
    import { POSTfunc } from "./api.js";
    import { GETfunc } from "./api.js";
    "use strict";
    const buttonWrite = document.getElementById("button_submit");
    const nameInput = document.getElementById("name_for_comment");
    const commentItself = document.getElementById("comment_area");
    const newList = document.getElementById("list_wrapper");
    const quotePlaceholder = document.querySelector(".quote_placeholder_textarea")
    const quotePlaceholder_divs = document.querySelectorAll(".quote_placeholder")
    let stringifyArr = ""
    let stringifyName
    const randArr = [];
    let userOfQuote = '';
    quotePlaceholder.value = "";
    let uneditedARR = [];
    const clearButton = document.querySelector(".quote_placeholder_clear")
    clearButton.addEventListener("click", () => {
      quotePlaceholder.value = "";
      for (const element of quotePlaceholder_divs) {
        element.classList.add("display_none")
        }
      }
    )

    let everyUser = []

    GETfunc()

    const inLikeButtonListeners = () => {
      const likeButtonElements = document.querySelectorAll(".like-button");
      for (const likeButtonElement of likeButtonElements) {
        likeButtonElement.addEventListener("click", () => {
          event.stopPropagation()
          const index = Number(likeButtonElement.dataset.index);
          for (let index1 = 0; index1 < everyUser.length; index1++) {
            if (everyUser[index1].index === index) {
              if (everyUser[index1].active === "") {
                everyUser[index1].likes += 1;
                everyUser[index1].active = "-active-like";
              } else {
                everyUser[index1].likes -= 1;
                everyUser[index1].active = "";
              }
            }
          }
          
          renderStudents();
        });
      }
    };

    const commentReply = () => {
      const commentReplyElements = document.querySelectorAll(".comment");
      for (const commentReplyElement of commentReplyElements) {
        commentReplyElement.addEventListener("click", () => {
          event.stopPropagation()
          const index = Number(commentReplyElement.dataset.index);
          for (let index1 = 0; index1 < everyUser.length; index1++) {
            if (everyUser[index1].index === index) {
              const textarea = document.querySelector(".quote_placeholder_textarea");
              textarea.value = everyUser[index1].comment;
              userOfQuote = everyUser[index1].name;
              for (const element of quotePlaceholder_divs) {
                element.classList.remove("display_none")
              }
            }
          }
          renderStudents();
        });
      }
    };

    const deleteButtons = () => {
      const deleteButtonsDivs = document.querySelectorAll(".delete")
      for (const deleteButton of deleteButtonsDivs) {
        deleteButton.addEventListener("click", () => {
          console.log("Element is in work!");
          event.stopPropagation()
          let id = Number(deleteButton.dataset.index)
          fetch ('https://wedev-api.sky.pro/api/v1/:egor-epifancev/comments/' + id, {
            method: 'DELETE' 
          })
          .then((response) => {
            return response.json();
          })
          .then((responseData) => {
            renderGET(responseData)
        });
          renderStudents();
        })
      }
    }

    
    
    renderStudents();

    buttonWrite.addEventListener("click", () => {
      const textarea = document.querySelector(".quote_placeholder_textarea")
      nameInput.value = nameInput.value.replaceAll("<", "&lt")
      nameInput.value = nameInput.value.replaceAll(">", "&gt")
      commentItself.value = commentItself.value.replaceAll("<", "&lt")
      commentItself.value = commentItself.value.replaceAll(">", "&gt")
      nameInput.classList.remove("error")
      commentItself.classList.remove("error")
      if ((nameInput.value === '') && (commentItself.value === '')) {
        nameInput.classList.add("error")
        commentItself.classList.add("error")
        return;
      }
      if (nameInput.value === '') {
        nameInput.classList.add("error")
        return;
      }
      if (commentItself.value === '') {
        commentItself.classList.add("error")
        return;
      }
      const date = new Date();
      let formattedDate = date.toLocaleString("en-GB", {
        day: "numeric",
        month: "numeric",
        year: "2-digit",
        hour: "numeric",
        minute: "numeric"
      });
      formattedDate = formattedDate.replaceAll('/', '.');
      formattedDate = formattedDate.replaceAll(',', '');
      if (textarea.value === "") {
        stringifyName = `${nameInput.value}`
        stringifyArr = `${commentItself.value}` 
      } else { 
        stringifyName = `${nameInput.value}`
        stringifyArr = `${commentItself.value}` + `|||` + `${textarea.value} - ${userOfQuote}`
      }
      let quoteValid = "";
      if (textarea.value === "") {
        quoteValid = ""
      } else {
        quoteValid = textarea.value + `- ${userOfQuote}`
      }
      

      buttonWrite.disabled = true;
      buttonWrite.textContent = "Загрузка."
      const formAdder = document.querySelector(".add-form")
      const loader = document.querySelector(".loader")
      loader.textContent.replaceAll(" ", "")
      console.log(loader);
      console.log(formAdder);
        
      let ErrorNumber = 0
      POSTfunc()
      renderStudents();
    })
  </script>
</html>
