<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="list_wrapper">
        
      </ul>
      <div class="add-form">
        <p>Автор:</p>
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="name_for_comment"
        />
        <p>Цитата:</p>
        <div class="quote_placeholder">
          <textarea 
            class="quote_placeholder_textarea" 
            style="overflow: hidden;" 
            disabled="yes">
          </textarea>
          <button class="quote_placeholder_clear">Очистить</button>
        </div>
        <p>Комментарий:</p>
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="comment_area"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="button_submit">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";
    const buttonWrite = document.getElementById("button_submit");
    const nameInput = document.getElementById("name_for_comment");
    const commentItself = document.getElementById("comment_area");
    const newList = document.getElementById("list_wrapper");
    const quotePlaceholder = document.querySelector(".quote_placeholder_textarea")
    console.log(quotePlaceholder.value);
    const clearButton = document.querySelector(".quote_placeholder_clear")
    clearButton.addEventListener("click", () => {
      quotePlaceholder.value = "";
    })
    const everyUser = [
      {
        name: "Глеб Фокин",
        comment: "Это будет первый комментарий на этой странице",
        date: "12.02.22 12:18",
        likes: 3,
        active: "",
        index: 0,
        quote: ''
      },

      {
        name: "Варвара Н.",
        comment: "Мне нравится как оформлена эта страница! ❤",
        date: "13.02.22 19:22",
        likes: 75,
        active: "-active-like",
        index: 1,
        quote: ''
      }
    ]

    

    const inLikeButtonListeners = () => {
      const likeButtonElements = document.querySelectorAll(".like-button");
      for (const likeButtonElement of likeButtonElements) {
        likeButtonElement.addEventListener("click", () => {
          event.stopPropagation()
          const index = Number(likeButtonElement.dataset.index);
          for (const element of everyUser) {
            if (element.index === index) {
              if (element.active === "") {
                element.likes += 1;
                element.active = "-active-like";
              } else {
                element.likes -= 1;
                element.active = "";
              }
            }
          }
          
          renderStudents();
        });
      }
    };
    const commentReply = () => {
      const commentReplyElements = document.querySelectorAll(".comment");
      for (const commentReplyElement of commentReplyElements) {
        commentReplyElement.addEventListener("click", () => {
          const index = Number(commentReplyElement.dataset.index);
          for (const element of everyUser) {
            if (element.index === index) {
              const textarea = document.querySelector(".quote_placeholder_textarea")
              console.log(textarea);
              textarea.value = element.comment
            }
          }
          
          renderStudents();
        });
      }
    };

    const renderStudents = () => {
      const everyComment = everyUser
      
        .map((user, index) => {
          if (user.quote === "") {
            return `
        <li class="comment" data-index="${index}">
          <div class="comment-header">
            <div>${user.name}</div>
            <div>${user.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${user.comment}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${user.likes}</span>
              <button data-index="${index}" class="like-button ${user.active}"></button>
            </div>
          </div>
        </li>`;
          } else {
          return `
        <li class="comment" data-index="${index}">
          <div class="comment-header">
            <div>${user.name}</div>
            <div>${user.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-quote quote_background">
              ${user.quote}
            </div>
            <div class="comment-text">
              ${user.comment}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${user.likes}</span>
              <button data-index="${index}" class="like-button ${user.active}"></button>
            </div>
          </div>
        </li>`;
          };
        })
        .join("");
      newList.innerHTML = everyComment;

      inLikeButtonListeners()
      commentReply()
    };
    
    renderStudents();

    buttonWrite.addEventListener("click", () => {
      const textarea = document.querySelector(".quote_placeholder_textarea")
      nameInput.value = nameInput.value.replaceAll("<", "&lt")
      nameInput.value = nameInput.value.replaceAll(">", "&gt")
      commentItself.value = commentItself.value.replaceAll("<", "&lt")
      commentItself.value = commentItself.value.replaceAll(">", "&gt")
      nameInput.classList.remove("error")
      commentItself.classList.remove("error")
      if ((nameInput.value === '') && (commentItself.value === '')) {
        nameInput.classList.add("error")
        commentItself.classList.add("error")
        return;
      }
      if (nameInput.value === '') {
        nameInput.classList.add("error")
        return;
      }
      if (commentItself.value === '') {
        commentItself.classList.add("error")
        return;
      }
      const date = new Date();
      let formattedDate = date.toLocaleString("en-GB", {
        day: "numeric",
        month: "numeric",
        year: "2-digit",
        hour: "numeric",
        minute: "numeric"
      });
      formattedDate = formattedDate.replaceAll('/', '.');
      formattedDate = formattedDate.replaceAll(',', '');
      everyUser.push({
        name: `${nameInput.value}`,
        comment: `${commentItself.value}`,
        date:`${formattedDate}`,
        likes: 0,
        active: "",
        index: everyUser.length,
        quote: textarea.value
      })
      renderStudents();
      nameInput.value = "";
      quotePlaceholder.value = "";
      commentItself.value = "";
    })
    console.log("It works!");
  </script>
</html>
